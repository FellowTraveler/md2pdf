#!/usr/bin/env bash
#
# md2pdf - Convert Markdown files to beautiful PDFs
#
# Usage: md2pdf <file.md> [theme]
#        md2pdf --list      # List available themes
#        md2pdf --preview   # Preview themes (generates samples)
#
# Themes are stored in ~/.md2pdf-themes/
#

set -e

THEME_DIR="$HOME/.md2pdf-themes"
DEFAULT_THEME="executive"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
BOLD='\033[1m'

show_help() {
    echo -e "${BOLD}md2pdf${NC} - Convert Markdown to beautiful PDFs"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "    md2pdf <file.md> [theme]     Convert markdown to PDF"
    echo "    md2pdf --list                List available themes"
    echo "    md2pdf --help                Show this help"
    echo ""
    echo -e "${BOLD}OUTPUT:${NC}"
    echo "    Creates a PDF file with the same name as the input file."
    echo "    Example: README.md -> README.pdf"
    echo ""
    echo -e "${BOLD}THEMES:${NC}"
    list_themes_brief
    echo ""
    echo -e "${BOLD}EXAMPLES:${NC}"
    echo "    md2pdf README.md             # -> README.pdf (default: executive)"
    echo "    md2pdf README.md minimal     # -> README.pdf (minimal theme)"
    echo "    md2pdf docs/guide.md modern  # -> docs/guide.pdf (modern theme)"
    echo ""
}

list_themes_brief() {
    if [[ -d "$THEME_DIR" ]]; then
        for theme in "$THEME_DIR"/*.css; do
            name=$(basename "$theme" .css)
            echo "    $name"
        done
    else
        echo "    (no themes found)"
    fi
}

list_themes() {
    echo -e "${BOLD}Available Themes:${NC}"
    echo ""

    if [[ ! -d "$THEME_DIR" ]]; then
        echo -e "${RED}Theme directory not found: $THEME_DIR${NC}"
        exit 1
    fi

    echo -e "  ${CYAN}executive${NC}  - Professional corporate style with navy blue accents"
    echo -e "             Best for: Business documents, proposals, reports"
    echo ""
    echo -e "  ${CYAN}minimal${NC}    - Clean, sparse design with maximum whitespace"
    echo -e "             Best for: Simple reports, personal documents"
    echo ""
    echo -e "  ${CYAN}academic${NC}   - Traditional serif typography"
    echo -e "             Best for: Papers, formal documents, articles"
    echo ""
    echo -e "  ${CYAN}modern${NC}     - Contemporary tech documentation style"
    echo -e "             Best for: Technical docs, API guides, READMEs"
    echo ""
    echo -e "  ${CYAN}github${NC}     - GitHub's markdown rendering style"
    echo -e "             Best for: README files, documentation"
    echo ""
    echo -e "  ${CYAN}dark${NC}       - Dark background with light text"
    echo -e "             Best for: Alternative aesthetics, presentations"
    echo ""
    echo -e "  ${CYAN}claude${NC}     - Claude Desktop's warm, clean aesthetic"
    echo -e "             Best for: General documents, presentations"
    echo ""
    echo -e "${BOLD}Usage:${NC} md2pdf <file.md> [theme]"
    echo ""
}

# Check arguments
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_help
    exit 0
fi

if [[ "$1" == "--list" ]] || [[ "$1" == "-l" ]]; then
    list_themes
    exit 0
fi

# Main conversion
INPUT_FILE="$1"
THEME="${2:-$DEFAULT_THEME}"

# Validate input file
if [[ ! -f "$INPUT_FILE" ]]; then
    echo -e "${RED}Error: File not found: $INPUT_FILE${NC}"
    exit 1
fi

# Validate theme
THEME_FILE="$THEME_DIR/$THEME.css"
if [[ ! -f "$THEME_FILE" ]]; then
    echo -e "${RED}Error: Theme not found: $THEME${NC}"
    echo ""
    echo "Available themes:"
    list_themes_brief
    exit 1
fi

# Generate output filename
OUTPUT_FILE="${INPUT_FILE%.md}.pdf"

echo -e "${BLUE}Converting:${NC} $INPUT_FILE"
echo -e "${BLUE}Theme:${NC}      $THEME"
echo -e "${BLUE}Output:${NC}     $OUTPUT_FILE"
echo ""

# Run md-to-pdf
npx --yes md-to-pdf "$INPUT_FILE" \
    --stylesheet "$THEME_FILE" \
    --pdf-options '{"format": "Letter", "margin": {"top": "0mm", "bottom": "0mm", "left": "0mm", "right": "0mm"}, "printBackground": true}' \
    2>&1 | grep -v "^$"

if [[ -f "$OUTPUT_FILE" ]]; then
    echo ""
    echo -e "${GREEN}✓ PDF created successfully: $OUTPUT_FILE${NC}"

    # Show file info
    SIZE=$(ls -lh "$OUTPUT_FILE" | awk '{print $5}')
    PAGES=$(pdfinfo "$OUTPUT_FILE" 2>/dev/null | grep "Pages:" | awk '{print $2}' || echo "?")
    echo -e "  Size: $SIZE, Pages: $PAGES"
else
    echo -e "${RED}✗ Failed to create PDF${NC}"
    exit 1
fi
