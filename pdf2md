#!/usr/bin/env bash
#
# pdf2md - Convert PDF files to Markdown
#
# Usage: pdf2md <file.pdf>
#        pdf2md --help
#
# Requires: Python 3 with pymupdf4llm
#           For image-based PDFs: tesseract, pytesseract, Pillow
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color
BOLD='\033[1m'

show_help() {
    echo -e "${BOLD}pdf2md${NC} - Convert PDF files to Markdown"
    echo ""
    echo -e "${BOLD}USAGE:${NC}"
    echo "    pdf2md <file.pdf>     Convert PDF to Markdown"
    echo "    pdf2md --help         Show this help"
    echo ""
    echo -e "${BOLD}OUTPUT:${NC}"
    echo "    Creates a Markdown file with the same name as the input file."
    echo "    Example: README.pdf -> README.md"
    echo ""
    echo -e "${BOLD}REQUIRES:${NC}"
    echo "    Python 3 with pymupdf4llm"
    echo "    Install: pip3 install pymupdf4llm"
    echo ""
    echo -e "${BOLD}OCR SUPPORT (for image-based PDFs):${NC}"
    echo "    tesseract, pytesseract, Pillow"
    echo "    Install: brew install tesseract && pip3 install pytesseract Pillow"
    echo ""
    echo -e "${BOLD}AI CLEANUP (optional, for OCR output):${NC}"
    echo "    Set ANTHROPIC_API_KEY to clean up messy OCR with Claude Haiku."
    echo "    Install: pip3 install anthropic"
    echo ""
}

# Check arguments
if [[ $# -eq 0 ]] || [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
    show_help
    exit 0
fi

# Check for Python 3
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}Error: Python 3 not found.${NC}"
    exit 1
fi

# Check for pymupdf4llm
if ! python3 -c "import pymupdf4llm" 2>/dev/null; then
    echo -e "${RED}Error: pymupdf4llm not found.${NC}"
    echo "Install: pip3 install pymupdf4llm"
    exit 1
fi

# Main conversion
INPUT_FILE="$1"

# Validate input file
if [[ ! -f "$INPUT_FILE" ]]; then
    echo -e "${RED}Error: File not found: $INPUT_FILE${NC}"
    exit 1
fi

if [[ "${INPUT_FILE##*.}" != "pdf" ]]; then
    echo -e "${RED}Error: Not a PDF file: $INPUT_FILE${NC}"
    exit 1
fi

# Generate output filename
OUTPUT_FILE="${INPUT_FILE%.pdf}.md"

echo -e "${BLUE}Converting:${NC} $INPUT_FILE"
echo -e "${BLUE}Output:${NC}     $OUTPUT_FILE"
echo ""

# Convert PDF to markdown using pymupdf4llm, with OCR fallback for image-based PDFs
OCR_USED=""
python3 - "$INPUT_FILE" "$OUTPUT_FILE" << 'PYEOF'
import sys
import pymupdf4llm

input_file = sys.argv[1]
output_file = sys.argv[2]

md = pymupdf4llm.to_markdown(input_file)

# If text extraction found content, write it and exit
if md.strip():
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(md)
    sys.exit(0)

# No text found — try OCR fallback
print("No text found in PDF, attempting OCR...", file=sys.stderr)
try:
    import pymupdf
    import pytesseract
    from PIL import Image
    import io
except ImportError as e:
    print(f"OCR dependencies not available: {e}", file=sys.stderr)
    print("Install: brew install tesseract && pip3 install pytesseract Pillow", file=sys.stderr)
    with open(output_file, "w", encoding="utf-8") as f:
        f.write("")
    sys.exit(0)

doc = pymupdf.open(input_file)
pages = []
for i, page in enumerate(doc):
    pix = page.get_pixmap(dpi=300)
    img = Image.open(io.BytesIO(pix.tobytes("png")))
    text = pytesseract.image_to_string(img)
    if text.strip():
        pages.append(text.strip())
    print(f"  OCR page {i + 1}/{len(doc)}", file=sys.stderr)
doc.close()

md = "\n\n---\n\n".join(pages)
with open(output_file, "w", encoding="utf-8") as f:
    f.write(md)

# Signal to the shell that OCR was used
with open("/tmp/pdf2md-ocr-used", "w") as f:
    f.write("1")
PYEOF

# Check if OCR was used for the status message
if [[ -f "/tmp/pdf2md-ocr-used" ]]; then
    OCR_USED="yes"
    rm -f "/tmp/pdf2md-ocr-used"
fi

# LLM cleanup for OCR output
if [[ -n "$OCR_USED" ]] && [[ -n "$ANTHROPIC_API_KEY" ]]; then
    echo -e "${BLUE}Cleaning up OCR output with LLM...${NC}"
    CLEANUP_TMP="${OUTPUT_FILE}.cleanup.tmp"
    python3 - "$OUTPUT_FILE" "$CLEANUP_TMP" << 'CLEANUP_PYEOF' || true
try:
    import anthropic
except ImportError:
    import sys
    print("anthropic package not installed, skipping LLM cleanup", file=sys.stderr)
    print("Install: pip3 install anthropic", file=sys.stderr)
    sys.exit(0)

import sys

output_file = sys.argv[1]
cleanup_tmp = sys.argv[2]

with open(output_file, "r", encoding="utf-8") as f:
    raw_md = f.read()

if not raw_md.strip():
    sys.exit(0)

client = anthropic.Anthropic()
message = client.messages.create(
    model="claude-haiku-4-5-20251001",
    max_tokens=16384,
    messages=[{"role": "user", "content": f"""You are a verbatim text reformatter. Reformat this raw OCR text into clean markdown.

CRITICAL RULES:
1. Keep ALL text VERBATIM — do NOT summarize, condense, or omit anything
2. Every sentence in the input must appear in the output
3. Fix only OCR artifacts (garbled characters, broken words)
4. Remove exact duplicate paragraphs from overlapping page captures
5. Restore markdown formatting (headers, bold, italic, bullets, tables, code blocks)
6. Remove UI chrome (Show more/less buttons, spinners, navigation elements)
7. Output ONLY the cleaned markdown, no preamble or explanation

You MUST NOT shorten, paraphrase, or summarize the text. The output should be approximately the same length as the input.

---
{raw_md}"""}],
)

cleaned = message.content[0].text
with open(cleanup_tmp, "w", encoding="utf-8") as f:
    f.write(cleaned)
CLEANUP_PYEOF
    if [[ -f "$CLEANUP_TMP" ]] && [[ -s "$CLEANUP_TMP" ]]; then
        mv "$CLEANUP_TMP" "$OUTPUT_FILE"
        echo -e "  ${GREEN}LLM cleanup complete${NC}"
    else
        rm -f "$CLEANUP_TMP"
        echo -e "  ${YELLOW}LLM cleanup failed, keeping raw OCR output${NC}"
    fi
elif [[ -n "$OCR_USED" ]] && [[ -z "$ANTHROPIC_API_KEY" ]]; then
    echo -e "  ${YELLOW}Tip: Set ANTHROPIC_API_KEY to enable AI cleanup of OCR output${NC}"
fi

if [[ -f "$OUTPUT_FILE" ]] && [[ -s "$OUTPUT_FILE" ]]; then
    echo -e "${GREEN}✓ Markdown created successfully: $OUTPUT_FILE${NC}"

    if [[ -n "$OCR_USED" ]]; then
        echo -e "  ${YELLOW}(used OCR — image-based PDF detected)${NC}"
    fi

    # Show file info
    SIZE=$(ls -lh "$OUTPUT_FILE" | awk '{print $5}')
    LINES=$(wc -l < "$OUTPUT_FILE" | tr -d ' ')
    echo -e "  Size: $SIZE, Lines: $LINES"
else
    echo -e "${RED}✗ Failed to create Markdown${NC}"
    exit 1
fi
